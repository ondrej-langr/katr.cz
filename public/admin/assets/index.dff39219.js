import{r as g,d as L,E as z,z as G,Y as H,j as r,Z as m,_ as K,$ as Q,a0 as Y,a1 as Z,a2 as A,a3 as _,a4 as J,h as c,F as X,a5 as ee,l as C,a6 as V,a7 as E,i as U,a8 as M,o as te,T as se,W as P,a9 as ae,aa as S,ab as j,ac as y,ad as re,x as O,v as ne,ae as oe,af as ie,ag as le,ah as T,ai as ce,aj as de}from"./index.edffba3d.js";var ue=Object.defineProperty,F=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,B=(s,e,t)=>e in s?ue(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,I=(s,e)=>{for(var t in e||(e={}))pe.call(e,t)&&B(s,t,e[t]);if(F)for(var t of F(e))me.call(e,t)&&B(s,t,e[t]);return s};function ge(s){const[e,t]=g.exports.useState(s);return[e,o=>t(n=>I(I({},n),typeof o=="function"?o(n):o))]}const R=g.exports.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),f=()=>g.exports.useContext(R),fe=({view:s,children:e})=>{const t=L(),{userId:i}=z(),o=G("users"),n=H(i,{revalidateIfStale:!1,revalidateOnFocus:!1,revalidateOnMount:!0,revalidateOnReconnect:!1,refreshWhenHidden:!1}),l=()=>t(m.getListUrl());return r(R.Provider,{value:{view:s,...n.data?{user:n.data}:{},mutateUser:n.mutate,isLoading:n.isLoading||n.isError,exitView:l,model:o},children:e})};function we(s){var e=s==null?0:s.length;return e?s[e-1]:void 0}var be=we,he=K,xe=Q;function ve(s,e){return e.length<2?s:he(s,xe(e,0,-1))}var Se=ve,Ue=Y,ke=be,Ne=Se,ye=Z;function _e(s,e){return e=Ue(e,s),s=Ne(s,e),s==null||delete s[ye(ke(e))]}var Ce=_e,Pe=Ce;function Ee(s,e){return s==null?!0:Pe(s,e)}var Re=Ee;const Me=()=>{const{model:s}=f(),e=A(),{formState:t}=_(),i=g.exports.useMemo(()=>{if(!s)return;const o={...s,columns:{...s.columns}};return o.columns.role&&!(e!=null&&e.can({action:"update",targetModel:"users"}))&&Re(o,"columns.role"),J(o)},[s,e]);return c(X,{children:[i&&r(ee,{fields:i}),t.isSubmitting&&r("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"})]})},Oe=()=>{const{view:s}=f(),{t:e}=C();return r("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:r("h1",{className:"m-0 text-5xl font-bold",children:e(s=="update"?"Update an user":"Create an user")})})},Te=()=>({aside:"xl:max-w-md w-full xl:mx-9 xl:mt-0 mt-5"}),Fe=({className:s,...e})=>r(j,{className:U("relative top-0.5 inline-block h-4",s),...e}),Be=()=>{const{isLoading:s,view:e,user:t,exitView:i,mutateUser:o}=f(),{watch:n,formState:{isSubmitting:l}}=_(),u=A(),w=n(),k=Te(),{t:a}=C(),d=V(),[b,N]=ge({isSendingPasswordReset:!1,isTogglingBlock:!1}),q=g.exports.useMemo(()=>e==="update"?!!Object.keys(E(t||{},w)).length:!0,[w,e,t]),D=async()=>{confirm(a(y.ON_DELETE_REQUEST_PROMPT))&&(i(),await re.delete({id:t==null?void 0:t.id,model:"users"}))},W=async()=>{N({isSendingPasswordReset:!0});const h=(t==null?void 0:t.state)===S.passwordReset;try{await d({title:a("Password reset"),message:a(h?"Resending password reset email":"Sending user password reset email"),successMessage:a("User can now follow instruction in their email")},async()=>{const p=await m.requestPasswordReset(t.id);await o(x=>{var v;if(x&&((v=p.data)==null?void 0:v.data))return{...x,...p.data.data}},{revalidate:!1})})}catch{}N({isSendingPasswordReset:!1})},$=async()=>{N({isTogglingBlock:!0});const h=t.state===S.blocked;try{await d({title:a(h?"Unblocking":"Blocking"),message:"",successMessage:a(h?"User is now unblocked":"User is now blocked")},async()=>{const p=await m.toggleBlock(t.id,h);await o(x=>{var v;if(x&&((v=p.data)==null?void 0:v.data))return{...x,...p.data.data}},{revalidate:!1})})}catch{}N({isTogglingBlock:!1})};return c("aside",{className:U(k.aside,"sticky top-0 grid gap-5"),children:[c(M,{className:"!pt-0",title:"Apply changes",children:[e==="update"&&r("div",{className:U("w-full bg-white py-5 px-4"),children:r("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:c("li",{children:[a("State"),":"," ",s?r(Fe,{className:"w-full max-w-[6rem]"}):r("span",{className:"font-semibold text-blue-600",children:t==null?void 0:t.state})]})})}),c("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[e==="update"?r(te,{size:"lg",type:"button",loading:l,onClick:D,color:"red",variant:"light",className:U(l&&"!cursor-progress","text-sm text-red-500"),children:r(se,{className:"aspect-square w-5"})}):r("span",{}),r(P,{size:"lg",color:"green",type:"submit",disabled:l||!q,loading:l,className:U(l&&"!cursor-progress"),children:a(l?e==="create"?"Creating...":"Updating...":e==="create"?"Create":"Update")})]})]}),e==="update"&&(u==null?void 0:u.can({action:"update",targetModel:"users"}))&&r(M,{title:a("Actions"),children:c(ae,{cols:1,className:"p-5",children:[r(P,{loading:b.isSendingPasswordReset,disabled:!t||(t==null?void 0:t.state)===S.blocked,onClick:W,children:a((t==null?void 0:t.state)===S.passwordReset?"Resend password reset":"Send password reset")}),r(P,{loading:b.isTogglingBlock,disabled:!t,color:"red",onClick:$,children:a((t==null?void 0:t.state)===S.blocked?"Unblock user":"Block user")})]})})]})},Ie=()=>{const s=L(),{view:e,user:t,mutateUser:i}=f(),o=V(),{t:n}=C(),{setError:l}=_();return async w=>{var k;try{await o({title:e==="update"?"Updating":"Creating",message:n(e==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:n(e==="update"?"User data has been updated!":"New user has been created!"),errorMessage:a=>{var d;return O.isAxiosError(a)&&((d=a.response)==null?void 0:d.status)===409?n(y.DUPLICATE_USER):n(y.ERROR_BASIC)}},async()=>{if(e==="update"){const a=await m.update(t==null?void 0:t.id,E(t,w));await i(d=>{var b;if(d&&((b=a==null?void 0:a.data)==null?void 0:b.data))return{...d,...a.data.data}},{revalidate:!1})}else if(e==="create"){const a=await m.create(E(t||{},w));a!=null&&a.data&&s(m.getListUrl())}})}catch(a){O.isAxiosError(a)&&((k=a.response)==null?void 0:k.status)===409&&l("email",{message:n(y.DUPLICATE_USER)})}}},Le=({children:s})=>{const{handleSubmit:e}=_(),t=Ie();return r("form",{onSubmit:e(t),autoComplete:"off",children:s})},Ae=()=>{var u;const{user:s,model:e,isLoading:t,view:i}=f(),{t:o}=C(),n=ne({defaultValues:s||{},reValidateMode:"onBlur",mode:"onTouched",resolver:i==="create"?T(ce):T(de)}),{reset:l}=n;return g.exports.useEffect(()=>{s&&l(s)},[s,l]),r(oe,{...n,children:c(Le,{children:[r(ie,{className:"py-5",items:[{content:le((e==null?void 0:e.tableName)||""),isLinkTo:`/${(u=e==null?void 0:e.tableName)==null?void 0:u.toLowerCase()}`},{content:o(i=="update"?"Update":"Create")},...i==="update"?[{content:t?r(j,{className:"h-4 w-16"}):r("p",{className:"text-green-500 underline",children:i=="update"?s==null?void 0:s.id:"Send invite"})}]:[]]}),c("div",{className:"mt-10 items-start justify-between xl:flex",children:[c("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[r(Oe,{}),r(Me,{})]}),r(Be,{})]})]})})},je={Context:R,ContextProvider:fe,useData:f,Content:Ae};export{je as U};
