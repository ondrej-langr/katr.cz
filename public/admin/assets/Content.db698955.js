import{r as p,e as I,R as $,z,$ as G,b as Q,j as a,p as O,a0 as H,a1 as K,a2 as J,a3 as X,a4 as F,a5 as U,a6 as Y,a7 as C,h as u,F as Z,a8 as ee,m as N,a9 as m,aa as B,ab as y,ac as se,ad as E,k as v,A as te,T as ae,ae as _,af as re,ag as h,ah as L,a as x,x as P,v as ne,ai as R,aj as oe,ak as ie,al as ce,am as le,D as de}from"./index.d960f72c.js";var ue=Object.defineProperty,M=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,T=(t,e,s)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,A=(t,e)=>{for(var s in e||(e={}))pe.call(e,s)&&T(t,s,e[s]);if(M)for(var s of M(e))me.call(e,s)&&T(t,s,e[s]);return t};function ge(t){const[e,s]=p.exports.useState(t),n=p.exports.useCallback(o=>s(r=>A(A({},r),typeof o=="function"?o(r):o)),[]);return[e,n]}const D=p.exports.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),S=()=>p.exports.useContext(D),Be=({view:t,children:e})=>{const s=I(),{userId:n}=$(),o=z("users"),r=G(n,{enabled:!1}),l=Q(),d=()=>s(O.users.list),g=p.exports.useCallback(i=>{l.setQueryData(r.key,c=>({...c,...i}))},[l,r.key]);return p.exports.useEffect(()=>(n&&r.refetch(),()=>r.remove()),[n]),a(D.Provider,{value:{view:t,...r.data?{user:r.data}:{},mutateUser:g,isLoading:r.isLoading||r.isError,exitView:d,model:o},children:e})};function fe(t){var e=t==null?0:t.length;return e?t[e-1]:void 0}var we=fe,be=H,he=K;function xe(t,e){return e.length<2?t:be(t,he(e,0,-1))}var Se=xe,ke=J,ve=we,Ue=Se,Ne=X;function _e(t,e){return e=ke(e,t),t=Ue(t,e),t==null||delete t[Ne(ve(e))]}var ye=_e,Ce=ye;function Ee(t,e){return t==null?!0:Ce(t,e)}var Pe=Ee;const Re=()=>{const{model:t}=S(),e=F(),{formState:s}=U(),n=p.exports.useMemo(()=>{if(!t)return;const o={...t,columns:new Map(t.columns)};return o.columns.has("role")&&!(e!=null&&e.can({action:"update",targetModel:"users"}))&&Pe(o,"columns.role"),Y(o,C.MAIN)},[t,e]);return u(Z,{children:[n&&a(ee,{type:C.MAIN,fields:n}),s.isSubmitting&&a("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"})]})},Me=()=>{const{view:t}=S(),{t:e}=N();return a("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:a("h1",{className:"m-0 text-5xl font-bold",children:e(t=="update"?m.UPDATE_AN_USER:m.CREATE_AN_USER)})})},Te=({className:t,...e})=>a(L,{className:v("relative top-0.5 inline-block h-4",t),...e}),Ae=()=>{const{isLoading:t,view:e,user:s,exitView:n,mutateUser:o}=S(),{watch:r,formState:{isSubmitting:l}}=U(),d=F(),g=r(),{t:i}=N(),c=B(),[f,k]=ge({isSendingPasswordReset:!1,isTogglingBlock:!1}),V=p.exports.useMemo(()=>e==="update"?!!Object.keys(y(s||{},g)).length:!0,[g,e,s]),j=async()=>{confirm(i(m.ON_DELETE_REQUEST_PROMPT))&&(n(),x.users.delete(s==null?void 0:s.id))},q=async()=>{k({isSendingPasswordReset:!0});const w=(s==null?void 0:s.state)===h.passwordReset;try{await c({title:i("Password reset"),message:i(w?"Resending password reset email":"Sending user password reset email"),successMessage:i("User can now follow instruction in their email")},async()=>{const{data:b}=await x.users.requestPasswordReset(s.email);o(b.data)})}catch{}k({isSendingPasswordReset:!1})},W=async()=>{k({isTogglingBlock:!0});const w=s.state===h.blocked;try{await c({title:i(w?"Unblocking":"Blocking"),message:"",successMessage:i(w?"User is now unblocked":"User is now blocked")},async()=>{const{data:b}=await x.users[w?"unblock":"block"](s.id);o(b.data)})}catch{}k({isTogglingBlock:!1})};return u(se,{isOpen:!0,children:[u(E,{className:"!pt-0",title:i(m.PUBLISH_INFO),children:[e==="update"&&a("div",{className:v("w-full bg-white py-5 px-4"),children:a("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:u("li",{children:[i(m.STATE),":"," ",t?a(Te,{className:"w-full max-w-[6rem]"}):a("span",{className:"font-semibold text-blue-600",children:s==null?void 0:s.state})]})})}),u("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[e==="update"?a(te,{size:"lg",type:"button",loading:l,onClick:j,color:"red",variant:"light",className:v(l&&"!cursor-progress","text-sm text-red-500"),children:a(ae,{className:"aspect-square w-5"})}):a("span",{}),a(_,{size:"lg",color:"green",type:"submit",disabled:l||!V,loading:l,className:v(l&&"!cursor-progress"),children:i(l?e==="create"?"Creating...":"Updating...":e==="create"?"Create":"Update")})]})]}),e==="update"&&(d==null?void 0:d.can({action:"update",targetModel:"users"}))&&a(E,{title:i("Actions"),children:u(re,{cols:1,className:"p-5",children:[a(_,{loading:f.isSendingPasswordReset,disabled:!s||(s==null?void 0:s.state)===h.blocked,onClick:q,children:i((s==null?void 0:s.state)===h.passwordReset?"Resend password reset":"Send password reset")}),a(_,{loading:f.isTogglingBlock,disabled:!s,color:"red",onClick:W,children:i((s==null?void 0:s.state)===h.blocked?"Unblock user":"Block user")})]})})]})},Ie=()=>{const t=I(),e=B(),{view:s,user:n,mutateUser:o}=S(),{t:r}=N(),{setError:l}=U();return async g=>{var i;try{await e({title:s==="update"?"Updating":"Creating",message:r(s==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:r(s==="update"?"User data has been updated!":"New user has been created!"),errorMessage:c=>{var f;return P.isAxiosError(c)&&((f=c.response)==null?void 0:f.status)===409?r(m.DUPLICATE_USER):r(m.ERROR_BASIC)}},async()=>{if(s==="update"){const c=await x.users.update(n==null?void 0:n.id,y(n,g));o(c.data.data)}else if(s==="create"){const c=await x.users.create(y(n||{},g));c!=null&&c.data&&t(O.users.list)}})}catch(c){P.isAxiosError(c)&&((i=c.response)==null?void 0:i.status)===409&&l("email",{message:r(m.DUPLICATE_USER)})}}},Oe=({children:t})=>{const{handleSubmit:e}=U(),s=Ie();return a("form",{onSubmit:e(s),autoComplete:"off",children:t})},Le=()=>{var d;const{user:t,model:e,isLoading:s,view:n}=S(),{t:o}=N(),r=ne({defaultValues:t||{},reValidateMode:"onBlur",mode:"onTouched",resolver:n==="create"?R(oe):R(ie)}),{reset:l}=r;return p.exports.useEffect(()=>{t&&l(t)},[t,l]),a(ce,{...r,children:u(Oe,{children:[a(le,{className:"py-5",items:[{content:o(de((e==null?void 0:e.tableName)||"")),isLinkTo:`/${(d=e==null?void 0:e.tableName)==null?void 0:d.toLowerCase()}`},{content:o(n=="update"?"Update":"Create")},...n==="update"?[{content:s?a(L,{className:"h-4 w-16"}):a("p",{className:"text-green-500 underline",children:n=="update"?t==null?void 0:t.id:"Send invite"})}]:[]]}),u("div",{className:"mt-10 items-start justify-between xl:flex",children:[u("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[a(Me,{}),a(Re,{})]}),a(Ae,{})]})]})})};export{Be as C,Le as a};
